このソフトの著作権はおちゃっこにあります。
ライセンスはLGPLです。

このプログラムは外部のライブラリを使用しています。
DirectX9.0c(マイクロソフトの3D描画ライブラリ)
OpenGL(３Ｄ描画ライブラリ(このプログラムではbulletからリンクされている))
bullet(オープンソースの物理演算ライブラリ)
FBX SDK 2013.3(Autodeskの互換用ファイル操作SDK  http://www.autodesk.com/fbx)

ソリューションファイルは
VisualStudio 2013 Professionalで作りました。
ソリューションは2013用です。
VCランタイムは2010を使用しています。


######メタセコイアのFBX読み込み########
メタセコイアでFBX出力する場合は
出力する前に面の三角化を実行してください。

メタセコイアでボーンを入れたらボーンダイアログでポーズ出力メニューを実行してください。

メタセコイアのFBX出力オプションで
スムージンググループをオフにし
バージョンは２０１３にしてください。


＃＃＃
2016/05/31 その２
	ボーン座標軸回転ダイアログを１度閉じたら次回以降開くことが出来ないバグを修正しました。
	ボーン座標軸の回転実行は、モーション長が長いと時間がかかります。すべてのオイラー角の再計算をするためです。


2016/05/31 その１
　　MameBake3D CustomRig ダイジェスト動画。
　　https://youtu.be/o7UUAqea6io

　　CustomRigを実装しました。GUIで設定可能なRigです。

	準備として「編集・変換」-->「オイラー角　角度制限」メニューでボーンの座標軸をCurrentAxisにします。
	設定するRigに関係するボーンの座標軸を「編集・変換」-->「ボーン座標軸回転」でRigに関係するボーンの座標軸を平行にします。
	Rigに関係するボーンが３つある場合、３のボーンともXYZが一致する必要はありません。
	あるボーンにとってのX軸があるボーンにとってのY軸やZ軸でも構いません。
	しかし、対応付ける軸同士が並行であるほうがきれいに曲がります。
	(現在、ボーン座標軸回転ダイアログは、バグのため一度閉じると再びは開きません。対応予定です。)

	軸を平行にする準備が出来たら
	Rigを設定する一番子供のボーンを右クリックします。もしくは左のウインドウのボーン名を右クリックします。
	そのボーンにまだRigを作成したことがなければ、「新規Rig」だけがメニューに出ます。
	Rigを設定してApplyボタンを押すとRigが登録されて、次回からは右クリックのメニューに作成したRigが出現します。

	Rigの設定ダイアログを出したら
	ボーンの階層数を指定します。
	何個上の階層まで設定するかの指定です。
	自分自身も１と数えるので、設定するボーンとその親のボーンの２個のボーンのRigを作成する場合は、階層数は２を選びます。

	階層数を選ぶとグループボックスに自動的に親方向にさかのぼったボーンの名前が表示されます。

	ボーンの名前が表示されているグループボックス内の設定をします。
	「横」「縦」とは、Rigマークの水色の球を横と縦にマウスでドラッグした時のことです。

	マウスをドラッグした時の回転軸と倍率を指定します。
	倍率はマイナスの数値も許されます。
	マイナスの数値は逆回転します。
	-100.0から100.0までの値が有効です。

	設定したらApplyボタンを忘れずに。

	後は水色の球をマウスでドラッグしながら数値や軸の調整をします。

	設定したデータを保存する場合にはFileメニューのSaveで「プロジェクトファイル」を選択して保存してください。
	開くときは*.chaファイルを開くとプロジェクト全体が読み込まれます。


	追記：
		RigコントロールはCustomRigDlgを開いていないと出来ません。
		CustomRigDlgを右上のｘで閉じると水色の球も消えて通常動作になります。


2016/05/29 その１
	姿勢編集結果を山状に適用する部分のデバッグをしました。
	選択フレーム数が２または３のときに姿勢の編集が出来ないバグを修正。
	applyframeのoffsetは必要ないことを確認。
	適用率の式を修正。

	toolWndの姿勢初期化を選んだ際にメニューを出します。
	メニューで全ボーンの姿勢初期化、選択ボーン１つの姿勢初期化、選択ボーンと子供ボーンの姿勢初期化
	の中から処理を選ぶことが出来ます。


2016/05/28 その２
	アンドゥーの高速化をしました。

2016/05/28 その１
	制限角度設定の保存と読み込み機能を付けました。
	制限角度設定ファイルは「FBXファイル名.fbx.lmt」です。
	FBXファイルの書き出し時またはプロジェクトファイルの書き出し時に保存されます。
	FBXを読み込む際にlmtファイルも読み込まれます。

	プロジェクトファイルには記述しませんが、FBXのファイル名に.lmtを付けたファイルを
	FBXの読み書き時に自動的に読み書きするということです。


2016/05/27
	Angle Limit DlgにVia180_X, Via180_Y, Via180_Zのチェックボックスを付けました。
	Viaとは電車のアナウンスでおなじみの「経由」の意味です。
	通常ならlower <= degree <= upperが可動範囲になるところを
	Via180のチェックを入れると ((-180 <= degree <= lower) || (upper <= degree <= 180))が可動範囲になります。
	つまり180を経由するような逆回りが可動範囲になります。

	ボーンの初期のオイラー角は0度です。
	可動範囲に０度が含まれていない場合、IKやFKで動かすことが出来ないと困るので
	メインウインドウに「回転角度制限をする」チェックボックスを追加しました。
	ボーンを可動範囲に入れるまでは「回転角度制限をする」のチェックをはずして、
	可動範囲に入れてからチェックをして、制限角度内で操作することが可能です。

	今回からWin10でビルドしています。
	VisualStudioは明示的には変更していません。

2016/05/26
	「編集・変換」-->「ボーン座標軸回転」メニューで
	ボーンの座標軸を回転可能にしました。

	長いフレームのモーションを読み込んでいる状態で実行すると
	全てのフレーム、全てのボーンに対してオイラー角の計算をし直すので
	メインウインドウのマニピュレータの向きに反映されるまで少し時間がかかります。

	ボーンの座標軸はFBXファイルに保存されるので
	変更を保存したい場合はFBXファイルの保存をしてください。


2016/05/24 その４
	Angle Limit Dlgにボーン座標系指定のコンボボックスを付けました。
	ボーンごとに座標系の指定が出来ます。
	座標系によって制限角度の掛かり方も変わります。
	
	制限角度設定時「以外」でもボーンを選択すると
	Angle Limit Dlgで指定した座標系に自動的に切り替わります。

	座標系によってメインウインドウ左上のオイラー角表示も変わります。

	メインウインドウの座標系指定コンボボックスは、Angle Limit Dlgで指定した座標系と異なるものも選ぶことが出来ます。
	そしてオイラー角表示はメインウインドウのコンボボックスでの指定に従います。
	しかし、回転の制限角度の掛かり方は、メインウインドウのコンボボックス指定にかかわらず
	Angle Limit Dlgで指定した座標系をもとに制限します。


2016/05/24 その３
	カレント座標系チェックボックスをやめて
	メインウインドウにコンボボックスを追加し、
	CurrentBoneAxis, ParentBoneAxis, GlobalAxis
	の３つの座標系から選択できるようになりました。
	
	選択したボーン座標系でIK, FK操作が可能です。

	角度制限はバインドポーズの座標系で行っています。

2016/05/24 その２
	メインウインドウに「カレント座標系」チェックボックスを追加してデフォルトでチェックしました。
	チェックを入れていない状態ではボーンの座標系はparent座標系(親のボーンの座標系)であり、
	チェックを入れるとcurrent座標系(現在の選択ボーンの座標系)になります。
	制限角度(の軸の把握)との相性はcurrent座標系の方が良い気がしたので、デフォルトをカレント座標系に変えました。


2016/05/24　その１
	Angle Limit Dlgをモードレスダイアログにしました。
	つまり、ダイアログを出してから他のウインドウのコントロールに対して操作可能です。
	スライダーで1度単位の設定をする場合には、スライダーをクリックしてからマウスホイールを回転させると簡単です。
	Angle Limit Dlgの設定はApplyボタンを押さないと正式に反映されないので注意してください。
	
2016/05/23
	「編集・変換」メニューに「オイラー角　角度制限」メニューを追加しました。
	ボーンを選択してからメニューを実行します。
	とりあえずモーダルダイアログです。
	スライダーでLower（下限）とUpper(上限)の角度を設定してApplyボタンを押すと適用されます。
	制限角度は-180度から180度の間で指定します。
	角度の基準はマニピュレータとして表示されている座標軸です。
	Lowerに-180、Upperに180を指定した場合に制限「なし」となります。

	選択ボーンの現在のオイラー角はメインウインドウの左上に表示されます。

	IK, FKの際に指定角度でクランプします。
	XYZどれか１つでも範囲からはみ出しているとIK,FKの際にボーンは動きません。
	（滑って動くタイプではなく、止まるタイプです）

	まだ制限角度の保存と読み込みが付いて「いません」のでテスト程度にしておいてください。


2016/05/19
	メインウインドウに選択ボーンのローカル座標系でのオイラー角を表示しました。
	XYZの回転はZ,X,Yの順番に回転します。
	複数の軸に対して回転を行うと操作中の軸以外の軸の角度が変化することがありますが
	これは回転順序の仕様でありバグではありません。

	もう少し詳しく説明します。
	回転角度の算出はZXYの順番で回転したと仮定して逆計算で求めます。
	それに対して、モーションの編集操作は
	操作している軸の回転が一番最初の回転になるように処理します(効果が直感的に分かるように)。
	ですからある軸の回転により他の軸の回転角度が変化することがあります。


2016/05/18
	操作をしているとアプリケーションエラーで落ちることが多かったのを修正。
	bonecntの後処理、Null Pointerのチェック。
	読み込み、姿勢編集、アンドゥー、fbx保存、モデル削除、読み込み、、、などを繰り返しても落ちなくなりました。

2016/05/17
	メタセコイアデータのZの向きの修正をしました。

	編集-->ボーン軸をZに再計算メニューを実行して保存しなおしてください。
	今後のIK,FKの角度制限設定のためにも、ボーン軸をZに再計算メニューを実行して保存しなおしてください。

2016/05/15
	新データと旧データの切り替えを自動にしました。
	
	旧データ
		データにボーンの座標軸が記録されていないがマニピュレータ表示時に軸を計算して表示していた。
	新データ
		データにボーンの座標軸が記録されており、マニピュレータ表示時にそれを使用する。

	ただし、2016/05/12から2016/05/15のこれより前のバージョン(RokDeBone2も含む)で保存した過渡期のファイルについては
	読み込み時に出る救済ダイアログでチェックボックスにチェックを入れて読み込む必要があります。
	過渡期ファイルである場合には、読み込み後速やかに保存しなおしてください。
	

2016/05/12
	ボーンの回転軸を考慮したバインドポーズに対応しました。
	RokDeBone2でボーンの回転軸に対応したFBXを書き出し、それを読み込むことが出来ます。

	古いRokDeBone2や古いMameBake3Dで出力したFBXを読み込むとボーンの位置がおかしくなることがあります。
	その場合はメインウインドウの右下の旧データ互換のチェックボックスをチェックして
	正常に表示されることを確認してから編集作業をする前にFBXを保存してください。
	新しいMameBake3Dで保存したFBXはボーンの回転軸を考慮したデータになります。
	ですので、それを読み込みなおす場合には旧データ互換のチェックをはずしてください。

	bvh2FBXでのFBXデータはbvhから変換しなおしてください。

2016/05/03
	動画。MameBake3D [新しいフレーム選択]。
	https://youtu.be/CfaFvEL2grM

2016/05/02
	フレーム選択
		「マウス中ボタンクリック-->マウスホイール-->マウス中ボタンクリック」
		で複数フレームを選択しますが、この代替方法を追加しました。
		「Ctrl+Shiftキー --> Aキー(マイナス側)Dキー(プラス側) -->Ctrl+Shiftキー」
		という方法です。
		マウスホイール中やA Dキー中にCtrlキーを押すと選択速度が5倍速になります。

	フレーム選択ヒストリー
		フレーム範囲選択を記憶して呼び出せるようにしました。
		最大１００００「種類」のフレーム選択範囲を記憶します。
		選択ヒストリーは登録隅の選択状態と同じ選択状態を記録しません。
		プレイヤーボタンの下印ボタンで過去方向のヒストリーを復元し、
		上印ボタンで未来方向のヒストリーを復元します。
		新たに登録した選択が解除された状態からの1回目の下印ボタンは現状復帰の機能をします。


2016/04/29
	フレーム選択：ホイールを回すときにCtrlキーを押している場合は選択速度を5倍速にしました。
	FBX出力：モーション長でソートすることにより複数モーション格納のFBXも正しく出力と入力ができるようになりました。
		テキスト形式からバイナリ形式にしました。読み込み速度が速くなりました。
	サンプル：サンプルのFBXをバイナリ形式にしました。

2016/04/27
	操作の見直し
	カメラの操作：メインウインドウの「移」「回」「拡」のスプライトでそれぞれ移動、回転、拡大します。
	フレーム選択：マウス中クリック-->マウスホイール-->マウス中クリック　の3アクションで選択します。
		　　　最初の中クリックはスタートフレームを決めます。クリック位置がスタートになります。
		　　　ホイールで選択範囲が伸びていきます。
		　　　最後の中クリックで選択範囲を確定します。このときのクリック位置は関係しません。

2016/04/25
	アイドリングが長いと剛体のシミュが終了して剛体が体についてこないことがある不具合を修正。
	時間制限を無効にしました。

	(test12のサンプルは読み込みに１０秒近くかかります(Visual Studioから起動しているときはもっとかかります。)。
	FBX書き出しをバイナリにすることを検討中。)

	(複数モーションを書き出して読み込んだ際に、モーションの長さがおかしい場合があります。
	FBX書き出し時にモーションの長さでソートして出力する必要があることを忘れていました。
	対応する予定です。)

2016/04/23
	最近の動画。

	MameBake3D 編集オプションの説明
	https://youtu.be/cA7ceFJ2oLY

	MameBake3D bvhそっと歩き＋物理ツインテ
	https://youtu.be/upwvM6yBGgw

2016/04/22
	Main.cppの相対IKと絶対IKの説明文を修正しました。
	test12の剛体パラメータでサンプルのキックのモーションを読み込んでF9したとき
	ツインテールが最初の位置付近に残りますが、
	これはバグではなくアイドリングタイムと運動停止の関係です。
	つまり長く動かないでいると停止状態になるのです。
	この辺も設定できるようにする予定です。

	その他、タイムラインの数値表示の間隔を調整しました。
	１０００フレームを越える場合も読み取れるようになりました。
	GetBefNextMPの使い方がわかりずらいので、
	置き換えることが出来る部分はGetMotionPointに置き換えました。

	bvhのモーション変換メニュー実行時に
	全体移動量は
	Hipsという名前のボーン限定ではなく、最初のボーンに限定して取得するようにしました。


2016/04/21
	全体回転考慮のオプションを拡張して、親の回転を考慮したIKとFKのオプションとしました。
	名付けて「PseudoLocal(疑似ローカル)」です。
	複数フレームに対する処理なのですが、それぞれのフレームの操作ボーンの親の回転を考慮して
	操作を反映させます。
	メインウインドウの右下に「PseudoLocal(疑似ローカル)」のチェックボックスがあります。
	デフォルトでオンになっています。

2016/04/20
	IK,FK操作結果にルートボーンの回転を考慮するようにしました。
	メインウインドウの右下に「全体回転考慮」というボタンがあります。
	例をあげますと、
	ルートボーンつまり全体が１回転するようなモーションに対する通常のIK,FK操作では
	前向き時に操作した結果がグローバル効果として横向き時にも適用されてしまいます。
	つまり前向き時に足を広げる操作をすると横向き時には足がクロスしてしまいます。
	「全体回転考慮」にチェックを入れると
	前向きのときに足を開く操作をすると横向きの時にも足を開く効果があります。

	マニピュレータの向きのバグを直しました。
	マニピュレータの軸の向きと回転操作の軸は一致します。
	RotateAxisDelta関数はshadow方式から座標系変換方式に変えました。	

2016/04/18
	タイムラインの「<<」ボタンで先頭フレームへジャンプ。
	タイムラインの「>>」ボタンで最終フレームへジャンプ。
	タイムラインの「| |」のマークのボタンを押すと現在のフレームから最後のフレームまでを選択します。
	選択した後に適用位置の％スライダーの値に対応するフレームに移動します。
	InitMPを変更しました。
	test10の剛体パラメータファイルrefファイルを修正しました。

2016/04/14
	F9を押したときのBtシミュレートが動かなくなっていたのを修正。
	bvhモーション＋btシミュ用のサンプルを追加。MameBake3D/Media/test12。
	test12.chaをOpenメニューで開いてF9を押すとbvhの歩き＋btシミュが再生されます。
	test12のパラメータでは、メインウインドウのmotion speedは2.5くらいまでが限界かもしれません。
	スピードが速くなると体の向きが１８０度変わるところでツインテールがぶるぶる震えます。
	ぷるぷる震えたらスペースキーを押してモーションを再生しながらbtをリセットすることも可能です。


2016/04/13
	bvhのコンバートテスト用のデータを追加しました。
	MameBake3D/Media/testBvhConv　です。
	
2016/04/12
	FBX読み込み時に一番親のボーンの位置が正しくなかったのを修正しました。

	BVHモーションコンバートを更新しました。
	bvh側のルートボーン指定をHipsに戻しました。

	BVHモーションコンバートを使用する際には
	BVHの最初のフレームのポーズと、モデル側の初期姿勢が同じ必要があります。
	一番はまりやすいのは、一番親のボーンの位置だと思います。
	BVHのモーションを適用していない初期姿勢は原点にありますが
	BVHのモーションを適用した初期姿勢はLHip,RHipと同位置にあることが多いようです。
	そのためモデル側のボーンを用意する際にはモデル側の一番親のボーンの位置を
	LHip, RHipと同位置にしたほうが良いようです。
	これを間違えると体全体の回転の中心がずれた変換結果になることが多いです。


2016/04/11
	BVHモーションコンバートのバージョンアップ。
	初期姿勢変換にbvh側の全体回転を考慮するようにしました。
	bvh側のルートボーン指定をHips_bunki***に限定する（想定している）ようにしています。
	以前の動画では、BVHモーションコンバートの対応ボーン指定時に
	最低限の指定をしたほうが良いと言っていましたが、すべてに指定したほうが良いようになっています。


2016/04/10
	BVHモーションコンバートのバージョンアップ。
	bvhとモデル側の位置や拡大率を合わせなくてもうまく変換できるようになりました。

2016/04/09
	BVHモーションコンバートのバージョンアップ。
	BVHの１フレーム目にモーションが設定してあっても、
	１フレーム目の姿勢とモデルの初期姿勢が同じであれば変換できるようになりました。

2016/04/07 
	法線をスムージングしてあるデータを読み込んだ場合のFBX書き出しをスムージングに対応させました。
	bvh用のFBXサンプルは準備中です。

2016/02/15 19:00頃のバージョン
	BVH2FBXで作成したデータをMakeBake3Dで読み込むことが出来、分岐ボーンも改善された。
	そのことに起因するかは調べ切れていないが
	ボーンのリストの選択と３Dのマニピュレータの選択がずれるようになっているのに気が付いた。
	以降のバージョンで修正予定である。

2016/02/15 19:50
	ボーンのリストとマニピュレータのずれは直った。
	BVH2FBXメニュー実行時の書き出し時に大きすぎる変化をカットするフィルターが付いているのであるが
	データによって可変であるべきことが分かった。
	以降のバージョンで修正予定である。

2016/02/16 19:00頃のバージョン
	分岐処理見直しと修正。
	bvhの回転順序の適用。
	ルートの回転移動修正。
	バインドポーズ修正。
	回転順序変換部分追加。
	Siteという同一名によるリスト選択のバグを修正。

2016/02/17 01:10頃のバージョン
	回転順序　再調整。
	bvh rotation filterの改良。
	BVH2FBXのダイアログにフィルター角度エディット欄を追加。

2016/02/17 09:45頃のバージョン
	BVH2FBXのオイラー角を抜本的に修正。
		再現率がかなりあがりました。
	
2016/02/17 11:20頃のバージョン
	複数のFBXを読み込んだ時のボーン表示のための機能を追加。
		複数読み込んだ後にCtrl + Aを押すと、読み込みモデルすべてのボーンを表示します。
		Ctrl + Aを押すたびにオンオフを切り替えます。
		普段はModelメニューで選択したモデルにしかボーンは表示されません。
		Ctrl + Aが有効の時には一番親からのボーンは表示されません。

2016/03/13
	モデルのFBXにモーションのFBXを適用する機能の追加。
	モデルとモーションとのボーン構造が多少異なっていても対応できます。

	モデルのボーンの位置にモーションのボーンの位置を合わせるような手作業は必要ありません。
	（初期姿勢が同じ必要はあります。例えばT字型の姿勢であるとか。）

	使い方の説明動画は
		https://youtu.be/ERaqn16GsU0



/////////// 以下、説明動画

MameBake3D CustomRig ダイジェスト動画。
https://youtu.be/o7UUAqea6io

MameBake3Dの使い方。ベイクの話。
ベイク済とは。ベイク済モーションの編集方法について。
https://youtu.be/Z0UacTlXs7w

MameBake3D 編集オプションの説明
https://youtu.be/cA7ceFJ2oLY

MameBake3D [新しいフレーム選択]。
https://youtu.be/CfaFvEL2grM

MameBake3D説明動画。モデルFBXにモーションFBXを適用する話。
https://youtu.be/ERaqn16GsU0

MameBake3Dの使い方。BVHからFBXへの変換の話。
オイラー角出力を抜本的に見直した結果、モーション再現率がかなり上昇しました。
perfumeの３人が踊る動画。
https://youtu.be/ONnB1jDVi6k

MameBake3D bvhそっと歩き＋物理ツインテ
https://youtu.be/upwvM6yBGgw

MameBake3Dの使い方。
(MameBake3DでbvhをFBXにしてMayaでモデルにバインドして
再びMameBake3Dで読み込み、アニメーションを修正するまでの説明動画)
http://youtu.be/EjGnHuXPZm0


MameBake3Dでの物理の設定の仕方。
http://youtu.be/56kIA5OsZ0M

///////////////////
サンプルについて
2016/03/30

Mediaフォルダの中にtest10を入れました。
test10.chaをオープンすると全部読み込まれます。
モーションの選択で「For_F9_Test」という名前のモーションを選んでから
F9を押すと物理シミュレートが動きツインテールが揺れます。
F10を押すと同じく物理でラグドールします。
バグが取れてきているので以前よりはかなり扱いやすくなっています。

2016/03/31

test10の中のfbxファイルのボーンはメタセコイアのBVHテンプレートの階層を少しいじって使用したものです。
先ほど気が付いたのですが、一般的なBVHと比べて足りないボーンがあるようです。
現在のmain.cppのConvBoneRotation関数は、モデル側のボーンがbvh側よりも多い時にはうまくいきますが
モデル側のボーンの方が少ない時にはうまくいきません。
モデルデータのアップデートをする予定ですが、少し時間がかかるかもしれません。
古いfbxもgitには含まれているはずですので、そちらで試してもらうのも良いかもしれません。


2016/04/08 18:30

bvhの適用がうまくいくものとうまくいかないものがありました。
うまくいかない原因は上記では、ボーンが足りないせいだということにしていました。
しかし、その後の調査でbvhの最初のフレームにもモーションが記述してある場合があることがわかりました。
つまり、初期姿勢が想定していたものと異なっていたのです。
（最初のフレームの姿勢は足を平行にしていたが、モーションを削除してみたら足は大の字だった。）
次の更新はこの辺の変換をしてみようと思います。

